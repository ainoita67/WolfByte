<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="utf-8">
        <script src="../../../javascript/sesion/authGuard.js"></script>
        <!-- SE CREA EL BASE PATH PARA USAR EN TODOS LOS SCRIPTS, ENLACES Y REDIRECCIONES-->
        <script>const BASE = window.location.origin + "/frontend";</script>
        <script>const API = window.location.origin + "/API";</script>
        <!--
        AÑADE:
            <script src="/ALEX/frontend/javascript/includes.js"></script>
            <script src="/ALEX/frontend/javascript/menu.js"></script>
        QUE GENERAN EL RESTO DE ENLACES DEL HEAD Y EL HEADER, NAV Y FOOTER
        -->
        <script>
            const script1 = document.createElement("script");
            script1.src = BASE + "/javascript/includes.js";
            script1.onload = () => {
                const script2 = document.createElement("script");
                script2.src = BASE + "/javascript/menu.js";
                script2.onload = () => {
                generarPagina("menu", "admin");
                };
                document.head.appendChild(script2);
            };
            document.head.appendChild(script1);
        </script>


        <title>Reservas Portátiles - IES Bajo Aragón</title>
    </head>
    <body>

        <div id="header"></div>
        <main class="container mt-5">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-center">Portátiles disponibles</h2>
                    <button class="btn bg-verde text-light" data-bs-toggle="modal" data-bs-target="#modalFiltrar">
                        <i class="bi bi-filter"></i> Filtrar
                    </button>
                </div>
                <div class="row g-4 contenedor-carros">
                    <!-- Aquí se insertarán las tarjetas de los carritos -->
                </div>

            <div class="divvolver container p-0 pb-3 mt-0 mb-5 pe-4 pe-md-0 text-end fs-5">
                <a href="../../menu.html" class="bg-azul rounded-pill p-2 px-3 ms-5 text-light"><i class="bi bi-caret-left-fill"></i> Volver</a>
            </div>
        </main>
        <!--Modal filtrar-->
            <div class="modal fade" id="modalFiltrar" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="bi bi-filter me-2"></i>Filtrar aulas</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <form id="formFiltrarAulas" class="px-3">
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-12 mb-3">
                                        <label class="form-label" for="f_fecha">Fecha</label>
                                        <input type="date" class="form-control" id="f_fecha">
                                    </div>
                                    <div class="col-12 col-md-6 mb-3">
                                        <label class="form-label" for="f_hora_inicio">Hora inicio</label>
                                        <select class="form-control" id="f_hora_inicio"></select>
                                    </div>
                                    <div class="col-12 col-md-6 mb-3">
                                        <label class="form-label" for="f_hora_fin">Hora fin</label>
                                        <select class="form-control" id="f_hora_fin"></select>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer d-flex justify-content-between">
                                <button type="submit" class="col-3 btn bg-azul border text-light rounded-3"><i class="bi bi-check2"></i> Aplicar filtros</button>
                                <button type="reset" class="col-3 btn bg-verde border text-light rounded-3"><i class="bi bi-arrow-clockwise"></i> Restablecer</button>
                                <button type="button" class="col-3 btn bg-lightgrey border text-dark rounded-3" data-bs-dismiss="modal"><i class="bi bi-x-lg"></i> Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
import { getCarritosDisponibles } from "/frontend/javascript/portatiles/get.js";

const TRAMOS = [
    { inicio: "08:50", fin: "09:40" },
    { inicio: "09:45", fin: "10:35" },
    { inicio: "10:40", fin: "11:30" },
    { inicio: "12:00", fin: "12:50" },
    { inicio: "12:55", fin: "13:45" },
    { inicio: "13:50", fin: "14:40" }
];

function cargarOpcionesHoras() {
    const selInicio = document.getElementById("f_hora_inicio");
    const selFin = document.getElementById("f_hora_fin");

    TRAMOS.forEach(tramo => {
        const opI = document.createElement("option");
        opI.value = tramo.inicio;
        opI.textContent = tramo.inicio;
        selInicio.appendChild(opI);

        const opF = document.createElement("option");
        opF.value = tramo.fin;
        opF.textContent = tramo.fin;
        selFin.appendChild(opF);
    });
}

function aplicarFechaYTramoActual() {
    const hoy = new Date().toISOString().split("T")[0];
    const tramo = getTramoActual();

    document.getElementById("f_fecha").value = hoy;
    document.getElementById("f_hora_inicio").value = tramo.inicio;
    document.getElementById("f_hora_fin").value = tramo.fin;

    return {
        fecha: hoy,
        horaInicio: tramo.inicio,
        horaFin: tramo.fin
    };
}

function getTramoActual() {
    const ahora = new Date();
    const horaActual = ahora.toTimeString().slice(0,5); // "HH:MM"

    // Buscar el primer tramo cuyo inicio sea posterior a la hora actual
    for (const tramo of TRAMOS) {
        if (horaActual <= tramo.inicio) {
            return tramo;
        }
    }

    // Si ya pasó el último → devolver el último tramo
    return TRAMOS[TRAMOS.length - 1];
}

document.addEventListener("DOMContentLoaded", async () => {

    const form = document.getElementById("formFiltrarAulas");
    cargarOpcionesHoras();
    const inputInicio = document.getElementById("f_hora_inicio");
    const inputFin = document.getElementById("f_hora_fin");

    inputInicio.addEventListener("change", () => {
        const tramo = TRAMOS.find(t => t.inicio === inputInicio.value);
        if (tramo) {
            inputFin.value = tramo.fin;
        }
    });
    inputFin.addEventListener("change", () => {
        const tramo = TRAMOS.find(t => t.fin === inputFin.value);
        if (tramo) {
            inputInicio.value = tramo.inicio;
        }
    });

    filtrosGuardadosyCrearTarjetas();

    //al enviar el formulario de filtrar
    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        let fecha = document.getElementById("f_fecha").value;
        let horaInicio = document.getElementById("f_hora_inicio").value;
        let horaFin = document.getElementById("f_hora_fin").value;

        const hoy = new Date().toISOString().split("T")[0];

        // Caso 1: nada seleccionado
        if (!fecha && !horaInicio) {
            fecha = hoy;
            const tramo = getTramoActual();
            horaInicio = tramo.inicio;
            horaFin = tramo.fin;
        }
        // Caso 2: fecha sí, hora no
        else if (fecha && !horaInicio) {
            const tramo = getTramoActual();
            horaInicio = tramo.inicio;
            horaFin = tramo.fin;
        }
        // Caso 3: inicio sí, fin no (por seguridad)
        else if (horaInicio && !horaFin) {
            const tramo = TRAMOS.find(t => t.inicio === horaInicio);
            if (tramo) horaFin = tramo.fin;
        }

        const data = await getCarritosDisponibles(fecha, horaInicio, horaFin);
        crearTarjetas(data);
        cerrarModal("modalFiltrar");
    });

    form.addEventListener("reset", async (e) => {
        e.preventDefault();
        sessionStorage.removeItem("filtrosCarros");

        const valores = aplicarFechaYTramoActual();

        const data = await getCarritosDisponibles(
            valores.fecha,
            valores.horaInicio,
            valores.horaFin
        );

        crearTarjetas(data);
    });

});

function cerrarModal(id) {
    const modalElement = document.getElementById(id);
    const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
    modal.hide();

    // Limpieza manual del backdrop (fix Bootstrap)
    setTimeout(() => {
        document.body.classList.remove("modal-open");
        document.body.style.removeProperty("padding-right");

        const backdrops = document.querySelectorAll(".modal-backdrop");
        backdrops.forEach(b => b.remove());
    }, 200);
}

async function filtrosGuardadosyCrearTarjetas(){

    const filtrosGuardados = sessionStorage.getItem("filtrosCarros");
    let fecha, horaInicio, horaFin;

    if (filtrosGuardados) {

        const filtros = JSON.parse(filtrosGuardados);

        fecha = filtros.fecha;
        horaInicio = filtros.horaInicio;
        horaFin = filtros.horaFin;

        // rellenar inputs
        document.getElementById("f_fecha").value = fecha;
        document.getElementById("f_hora_inicio").value = horaInicio;
        document.getElementById("f_hora_fin").value = horaFin;

    } else {

        const valores = aplicarFechaYTramoActual();
        fecha = valores.fecha;
        horaInicio = valores.horaInicio;
        horaFin = valores.horaFin;
    }

    const data = await getCarritosDisponibles(fecha, horaInicio, horaFin);
    crearTarjetas(data);
}

function crearTarjetas(carros) {
    const contenedor = document.querySelector(".contenedor-carros");
    contenedor.innerHTML = "";

    carros.forEach(carro => {

        const col = document.createElement("div");
        col.className = "col-12 col-md-6 col-lg-4";

        /* CARD */
        const card = document.createElement("div");
        card.className = "carro-card h-100 d-flex flex-column";

            /* TÍTULO */
            const h3 = document.createElement("h3");
            h3.textContent = `${carro.id} - ${carro.descripcion}`;

            /* BODY */
            const body = document.createElement("div");
            body.className = "carro-body";

                /* INFO */
                const info = document.createElement("div");
                info.className = "carro-info";
                    const strong = document.createElement("strong");
                    strong.textContent = carro.edificio;
                    info.appendChild(strong);
                    info.append(` ${carro.planta}`);

                /* MÉTRICAS */
                const metricas = document.createElement("div");
                metricas.className = "carro-metricas";

                    //totales
                    const totales = document.createElement("div");
                    totales.className = "carro-metrica";
                        const totalesNum = document.createElement("div");
                        totalesNum.className = "carro-metrica-num";
                        totalesNum.textContent = carro.totales;
                        const totalesLabel = document.createElement("div");
                        totalesLabel.className = "carro-metrica-label";
                        totalesLabel.textContent = "Totales";
                        totales.appendChild(totalesNum);
                        totales.appendChild(totalesLabel);
                    
                    //totales
                    const uso = document.createElement("div");
                    uso.classList = "carro-metrica ocupados";
                        const usoNum = document.createElement("div");
                        usoNum.className = "carro-metrica-num";
                        usoNum.textContent = carro.reservados;
                        const usoLabel = document.createElement("div");
                        usoLabel.className = "carro-metrica-label";
                        usoLabel.textContent = "En uso";
                        uso.appendChild(usoNum);
                        uso.appendChild(usoLabel);
                    
                    //totales
                    const libres = document.createElement("div");
                    libres.classList = "carro-metrica libres";
                        const libresNum = document.createElement("div");
                        libresNum.className = "carro-metrica-num";
                        libresNum.textContent = carro.disponibles;
                        const libresLabel = document.createElement("div");
                        libresLabel.className = "carro-metrica-label";
                        libresLabel.textContent = "Libres";
                        libres.appendChild(libresNum);
                        libres.appendChild(libresLabel);
                    metricas.appendChild(totales);
                    metricas.appendChild(uso);
                    metricas.appendChild(libres);
                
                body.appendChild(info);
                body.appendChild(metricas);
            /* FOOTER */
            const footer = document.createElement("div");
            footer.className = "carro-footer";

                const btn = document.createElement("button");
                btn.className = "btn bg-azul text-light w-100 btn-reservar";
                btn.innerHTML = `<i class="bi bi-calendar-check"></i> Reservar`;

                /* REDIRECCIÓN */
                btn.addEventListener("click", () => {
                    const filtros = {
                        fecha: document.getElementById("f_fecha").value,
                        horaInicio: document.getElementById("f_hora_inicio").value,
                        horaFin: document.getElementById("f_hora_fin").value,
                    };

                    sessionStorage.setItem("filtrosCarros", JSON.stringify(filtros));

                    const id = carro.id;
                    window.location.href = `${BASE}/vistas/reservas/portatiles/vistasemanal.html?id=${encodeURIComponent(id)}`;
                });
                footer.appendChild(btn);

            card.appendChild(h3);
            card.appendChild(body);
            card.appendChild(footer);
        col.appendChild(card);
        contenedor.appendChild(col);
    });
}
        </script>
        <footer id="footer"></footer>
    </body>
</html>
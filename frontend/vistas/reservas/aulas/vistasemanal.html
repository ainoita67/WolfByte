<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="utf-8">
        <script src="../../../javascript/sesion/authGuard.js"></script>
        <!-- SE CREA EL BASE PATH PARA USAR EN TODOS LOS SCRIPTS, ENLACES Y REDIRECCIONES-->
        <script>const BASE = window.location.origin + "/frontend";</script>
        <script>const API = window.location.origin + "/API";</script>
        <!--
        AÑADE:
            <script src="/ALEX/frontend/javascript/includes.js"></script>
            <script src="/ALEX/frontend/javascript/menu.js"></script>
        QUE GENERAN EL RESTO DE ENLACES DEL HEAD Y EL HEADER, NAV Y FOOTER
        -->
        <script>
            const script1 = document.createElement("script");
            script1.src = BASE + "/javascript/includes.js";
            script1.onload = () => {
                const script2 = document.createElement("script");
                script2.src = BASE + "/javascript/menu.js";
                script2.onload = () => {
                generarPagina("menu", "admin");
                };
                document.head.appendChild(script2);
            };
            document.head.appendChild(script1);
        </script>


        <title>Salón de Actos - IES Bajo Aragón</title>
    </head>
    <body>

        <div id="header"></div>

        <main>
            <script src="../../../assets/daypilot/daypilot-all.min.js"></script>
            <link type="text/css" rel="stylesheet" href="../../../assets/css/calendar_green.css" />  
            
            <div class="container my-4 d-flex flex-column" style="height: 50vh;">
                <div class="row d-flex justify-content-between align-items-center mb-3">
                    <button id="prevWeek"
                            type="button"
                            class="btn btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center p-0 border-0"
                            style="width: 2.5rem; height: 2.5rem;">
                    <i class="bi bi-arrow-left-circle fs-2"></i>
                    </button>
                    <button id="nextWeek"
                            type="button"
                            class="btn btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center p-0 border-0"
                            style="width: 2.5rem; height: 2.5rem;">
                    <i class="bi bi-arrow-right-circle fs-2"></i>
                    </button>


                </div>

                <div id="dp" class="flex-grow-1"></div>
            </div>


<script>
document.addEventListener("DOMContentLoaded", async () => {
    const dp = new DayPilot.Calendar("dp", {
        viewType: "Week",
        theme: "calendar_green",
        startDate: DayPilot.Date.today(),

        locale: "es-es",            // formato europeo
        headerDateFormat: "dd/MM/yyyy",
        weekStarts: 1,

        cellDuration: 5,
        cellHeight: 8, 
        businessBeginsHour: 8,
        businessEndsHour: 22,
        eventDeleteHandling: "Disabled",
        heightSpec: "BusinessHoursNoScroll"

    });

    dp.events.list = crearSlots();
    cargarReservasSalon();
    dp.init();


    // BOTONES SEMANA ANTERIOR Y SIGUIENTE
    document.getElementById("prevWeek").addEventListener("click", () => {
        dp.startDate = dp.startDate.addDays(-7);
        dp.update();
    });

    document.getElementById("nextWeek").addEventListener("click", () => {
        dp.startDate = dp.startDate.addDays(7);
        dp.update();
    });


    // crear las "plantillas" de casillas en las que poder reservar
    function crearSlots() {
        const slots = [
            { start: "08:50", end: "09:40" },
            { start: "09:45", end: "10:35" },
            { start: "10:40", end: "11:30" },
            { start: "12:00", end: "12:50" },
            { start: "12:55", end: "13:45" },
            { start: "13:50", end: "14:40" }
        ];

        // Añadir franjas cada 30 min a partir de las 14:00 hasta 20:00
        for (let h = 15; h < 22; h++) {
            slots.push({ start: `${h.toString().padStart(2,'0')}:00`, end: `${h.toString().padStart(2,'0')}:30` });
            slots.push({ start: `${h.toString().padStart(2,'0')}:30`, end: `${(h+1).toString().padStart(2,'0')}:00` });
        }

        // Convertir a eventos de DayPilot para un día concreto (ejemplo: lunes 6 febrero 2026)
        const day = "2026-02-06";
        const events = slots.map((s,i) => ({
            start: `${day}T${s.start}:00`,
            end: `${day}T${s.end}:00`,
            id: `slot-${i}`,
            text: "Disponible",
            backColor: "#dcdcdc",
            borderColor: "#c3c3c3",
            fontColor: "#212529",
            barHidden: true
        }));
        return events;
    }

    // Cargar reservas
    async function cargarReservasSalon() {
        try {
            const res = await fetch(`${API}/reservas-salon-actos`, {
                headers: {
                    "Authorization": "Bearer " + localStorage.getItem("token")
                }
            });

            const text = await res.text(); // primero leemos como texto
            let json;
            try {
                json = JSON.parse(text); // luego intentamos parsear a JSON
            } catch {
                console.error("Respuesta no es JSON:", text);
                return;
            }

            if (json.status !== "success") {
                console.error("Error API:", json);
                return;
            }

            const eventos = json.data.data.map(r => ({
                id: r.id_reserva,
                text: `${r.asignatura} - ${r.grupo}\n${r.profesor} - ${r.actividad}`,
                start: r.inicio.replace(" ", "T"),
                end: r.fin.replace(" ", "T")
            }));

            dp.events.list = dp.events.list.concat(eventos);
            dp.update();

        } catch (error) {
            console.error("Error cargando reservas:", error);
        }
    }
});



</script>

        </main>
        <footer id="footer"></footer>
    </body>
</html>
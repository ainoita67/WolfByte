<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="utf-8">
        <!-- SE CREA EL BASE PATH PARA USAR EN TODOS LOS SCRIPTS, ENLACES Y REDIRECCIONES-->
        <script>const BASE = window.location.origin + "/frontend";</script>
        <!--
        A√ëADE:
            <script src="/ALEX/frontend/javascript/includes.js"></script>
            <script src="/ALEX/frontend/javascript/menu.js"></script>
        QUE GENERAN EL RESTO DE ENLACES DEL HEAD Y EL HEADER, NAV Y FOOTER
        -->
        <script>
            const script1 = document.createElement("script");
            script1.src = BASE + "/javascript/includes.js";
            script1.onload = () => {
                const script2 = document.createElement("script");
                script2.src = BASE + "/javascript/menu.js";
                script2.onload = () => {
                generarPagina("menu", "admin");
                };
                document.head.appendChild(script2);
            };
            document.head.appendChild(script1);
        </script>


        <title>Sal√≥n de Actos - IES Bajo Arag√≥n</title>
    </head>
    <body>

        <div id="header"></div>

        <main>
            <script src="../../../assets/daypilot/daypilot-all.min.js"></script>
            <link type="text/css" rel="stylesheet" href="../../../assets/css/calendar_green.css" />  
            
            <div class="container my-5">
                <div id="dp"></div>
            </div>


            
<script>
document.addEventListener("DOMContentLoaded", async () => {

    // 1Ô∏è‚É£ Crear calendario
    const dp = new DayPilot.Calendar("dp", {
        viewType: "Week",
        theme: "calendar_green",
        startDate: DayPilot.Date.today()
    });

    // 2Ô∏è‚É£ Drag & drop
    dp.onEventMoved = async args => {
        await actualizarReserva(args);
    };

    dp.init();

    // 3Ô∏è‚É£ Cargar reservas
    async function cargarReservasSalon() {
        try {
            const res = await fetch("http://192.168.13.202/API/reservas-salon-actos", {
                headers: {
                    "Authorization": "Bearer " + localStorage.getItem("token")
                }
            });

            const text = await res.text(); // üîπ primero leemos como texto
            let json;
            try {
                json = JSON.parse(text); // üîπ parseamos JSON
            } catch {
                console.error("Respuesta no es JSON:", text);
                return;
            }

            if (json.status !== "success") {
                console.error("Error API:", json);
                return;
            }

            const eventos = json.data.data.map(r => ({
                id: r.id_reserva,
                text: `${r.asignatura} - ${r.grupo}\n${r.profesor} - ${r.actividad}`,
                start: r.inicio.replace(" ", "T"),
                end: r.fin.replace(" ", "T")
            }));

            dp.events.list = eventos;
            dp.update();

        } catch (error) {
            console.error("Error cargando reservas:", error);
        }
    }

    cargarReservasSalon();

});

// 4Ô∏è‚É£ Funci√≥n para actualizar fechas
// Modificar la funci√≥n actualizarReserva para mostrar mejor los errores
async function actualizarReserva(args) {
    const idReserva = args.e.id();
    const inicio = args.newStart.toString();
    const fin = args.newEnd.toString();

    try {
        const res = await fetch(
            `http://192.168.13.202/API/reservas/${idReserva}/fechas`,
            {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + localStorage.getItem("token")
                },
                body: JSON.stringify({ inicio, fin })
            }
        );

        const text = await res.text();
        let json;
        
        try {
            json = JSON.parse(text);
        } catch {
            console.error("Respuesta no es JSON:", text);
            alert("Error del servidor (respuesta inv√°lida)");
            args.preventDefault();
            return;
        }

        if (json.status !== "success") {
            // Mostrar mensaje espec√≠fico si existe
            const mensaje = json.message || json.data?.message || "No se pudo guardar el cambio";
            alert(`‚ùå Error: ${mensaje}`);
            args.preventDefault();
            return;
        }
        
        // √âxito
        console.log("Reserva actualizada correctamente");
        
    } catch (error) {
        console.error(error);
        alert("Error de conexi√≥n con el servidor");
        args.preventDefault();
    }
}

// A√±ade esta funci√≥n para verificar solapamientos
async function verificarSolapamiento(inicio, fin, idExcluir = null) {
    try {
        const res = await fetch("http://192.168.13.202/API/reservas-salon-actos", {
            headers: {
                "Authorization": "Bearer " + localStorage.getItem("token")
            }
        });
        
        const data = await res.json();
        
        if (data.status !== "success") return true; // Por precauci√≥n
        
        const nuevasInicio = new Date(inicio);
        const nuevasFin = new Date(fin);
        
        // Verificar solapamiento con otras reservas
        const haySolapamiento = data.data.data.some(r => {
            // Excluir la reserva actual que estamos moviendo
            if (idExcluir && r.id_reserva == idExcluir) return false;
            
            const existenteInicio = new Date(r.inicio.replace(" ", "T"));
            const existenteFin = new Date(r.fin.replace(" ", "T"));
            
            // Comprobar si se solapan
            return (
                (nuevasInicio < existenteFin && nuevasFin > existenteInicio) ||
                (nuevasInicio.getTime() === existenteInicio.getTime() && 
                 nuevasFin.getTime() === existenteFin.getTime())
            );
        });
        
        return haySolapamiento;
        
    } catch (error) {
        console.error("Error verificando solapamiento:", error);
        return true; // Por precauci√≥n
    }
}

// Modificar el onEventMoved para incluir validaci√≥n
dp.onEventMoved = async args => {
    // Verificar solapamiento antes de mover
    const haySolapamiento = await verificarSolapamiento(
        args.newStart.toString(),
        args.newEnd.toString(),
        args.e.id() // ID de la reserva que estamos moviendo
    );
    
    if (haySolapamiento) {
        alert("‚ö†Ô∏è No se puede mover la reserva. El horario se solapa con otra reserva existente.");
        args.preventDefault(); // Cancelar el movimiento
        return;
    }
    
    // Si no hay solapamiento, proceder
    await actualizarReserva(args);
};

// Funci√≥n para resaltar horas ocupadas
function resaltarHorasOcupadas(calendario, reservas) {
    // Puedes usar esta funci√≥n para colorear de diferente manera
    // las horas que ya est√°n reservadas
    const eventos = calendario.events.list;
    
    eventos.forEach(evento => {
        // A√±adir clase CSS si quieres resaltarlos
        evento.backColor = evento.backColor || "#3788d8";
    });
    
    calendario.update();
}
</script>



        </main>
        <footer id="footer"></footer>
    </body>
</html>